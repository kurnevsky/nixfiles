{ pkgs, ... }:

let
  key = ''
    -----BEGIN PGP PUBLIC KEY BLOCK-----

    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
    =UgmI
    -----END PGP PUBLIC KEY BLOCK-----
  '';
  gpgKeyring =
    pkgs.runCommand "gpg-keyring" { buildInputs = [ pkgs.gnupg ]; } ''
      mkdir -p $out
      export GNUPGHOME=$out
      gpg --no-default-keyring --keyring=$out/import-pubring.gpg --fingerprint
      gpg --no-default-keyring --keyring=$out/import-pubring.gpg --import <<< '${key}'
      rm $out/S.scdaemon $out/S.gpg-agent $out/S.gpg-agent.*
    '';
in {
  environment.etc."systemd/import-pubring.gpg".source =
    "${gpgKeyring}/import-pubring.gpg";
  systemd = {
    targets.machines.enable = true;
    nspawn."archlinux" = {
      execConfig.Boot = true;
      networkConfig.Private = false;
    };

    # To install arch linux container use:
    # machinectl pull-tar https://hub.nspawn.org/storage/archlinux/archlinux/tar/image.tar.zstd archlinux
    # See the issue: https://github.com/NixOS/nixpkgs/issues/108158
  };
}
